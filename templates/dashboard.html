{% extends "base.html" %}
{% block title %}Dashboard - Fantasy Baseball Tracker{% endblock %}
{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            height: auto;
            display: block;
            padding-top: 20px;
        }
        .container {
            max-width: 800px;
        }
        .card {
            margin-bottom: 1rem;
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .card:hover {
            transform: scale(1.02);
        }
        .card-body {
            padding: 1rem;
        }
        .card-title {
            font-size: 1.5rem;
        }
        .card-text {
            font-size: 0.9rem;
        }
        h4 {
            font-size: 1.25rem;
        }
        canvas {
            max-width: 100%;
            height: 150px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #4CAF50;
        }
    </style>
{% endblock %}
{% block content %}
<h2 class="text-center mb-4">Your Contests Dashboard</h2>
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="alert alert-{{ messages[0][0] }}">
            {% for category, message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}
<div class="mb-3 text-center">
    <a href="{{ url_for('create_contest') }}" class="btn btn-primary">Create New Contest</a>
</div>
<div class="loading" id="loading">Loading contests...</div>
{% if contest_data %}
    {% for data in contest_data %}
        <div class="card mb-3" onclick="window.location.href = '{{ url_for('results', contest_id=data.contest.id) }}';">
            <div class="card-body">
                <h3 class="card-title">{{ data.contest.title or 'Untitled Contest' }}</h3>
                <p class="card-text"><strong>League:</strong> {{ data.contest.league.name }}</p>
                <p class="card-text"><strong>Category:</strong> {{ data.contest.stat_category }}</p>
                <p class="card-text"><strong>Date Range:</strong> {{ data.contest.start_date }} to {{ data.contest.end_date }}</p>
                {% if data.status.is_started == False %}
                    <p class="text-info"><strong>Contest not started yet. Starts in {{ data.status.days_to_start }} days</strong></p>
                {% elif data.status.is_complete == False %}
                    <p class="text-info"><strong>Contest in progress. {{ data.status.days_remaining }} days remaining</strong></p>
                {% else %}
                    <p class="text-success"><strong>Contest Complete. Winner: {{ data.status.winner }}</strong></p>
                {% endif %}
                {% if data.warning_message %}
                    <p class="text-danger">{{ data.warning_message }}</p>
                {% endif %}
                {% if data.chart_data.labels | length > 0 %}
                    <h4>Rankings</h4>
                    <ul class="list-group list-group-flush">
                        {% for i in range(data.chart_data.labels|length) %}
                            <li class="list-group-item">{{ data.chart_data.labels[i] }}: {{ data.chart_data.datasets[0].data[i] | format_stat(data.contest.stat_category) }}</li>
                        {% endfor %}
                    </ul>
                    <canvas id="chart_{{ loop.index }}" class="mt-3"></canvas>
                    <script>
                        var ctx = document.getElementById('chart_{{ loop.index }}').getContext('2d');
                        var chartData = {{ data.chart_data | tojson }};
                        new Chart(ctx, {
                            type: 'bar',
                            data: chartData,
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: true
                                    }
                                }
                            }
                        });
                    </script>
                {% endif %}
                <div class="mt-3">
                    <form action="{{ url_for('delete_contest', contest_id=data.contest.id) }}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-danger" onclick="event.stopPropagation();">Delete Contest</button>
                    </form>
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ url_for('results', contest_id=data.contest.id, _external=True) | urlencode }}" target="_blank" class="btn btn-primary" onclick="event.stopPropagation();">Share on Facebook</a>
                </div>
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="text-center">
        <p>No contests yet. <a href="{{ url_for('create_contest') }}">Create one!</a></p>
    </div>
{% endif %}
<div class="nav-link text-center mt-3">
    <a href="{{ url_for('link_league') }}">Link Another League</a> |
    <a href="{{ url_for('my_leagues') }}">Manage My Leagues</a> |
    {% if current_user.is_authenticated %}
        <a href="{{ url_for('logout') }}">Logout</a>
    {% endif %}
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const loading = document.getElementById('loading');
        loading.style.display = 'block';
        setTimeout(() => { loading.style.display = 'none'; }, 1000);
    });
</script>
{% endblock %}